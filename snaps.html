<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Pasyak Reels</title>
    <style>
        * {
            outline: none !important;
            box-shadow: none !important;
            -webkit-tap-highlight-color: transparent;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
        }

        html,
        body {
            height: 100%;
            background: #121212FF;
            overflow: hidden;
            font-family: Arial, sans-serif;
            color: white;
        }

        #loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212FF;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
        }

        .spinner {
            border: 4px solid #333;
            border-top: 4px solid white;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }
            100% {
                transform: rotate(360deg);
            }
        }

        #app {
            height: 100vh;
            width: 100vw;
            position: relative;
            overflow: hidden;
            background: #121212FF;
            scroll-behavior: smooth;
            touch-action: none;
        }

        .reel {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #121212FF;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transform: translateY(100%);
            transition: transform 0.5s ease, opacity 0.5s ease;
            pointer-events: none;
        }

        .reel.active {
            opacity: 1;
            transform: translateY(0);
            z-index: 2;
            pointer-events: auto;
        }

        video {
            width: 100%;
            height: 100%;
            object-fit: contain;
            background: #121212FF;
            user-select: none;
            cursor: pointer;
            display: none;
        }
        
        .reel-loader {
            border: 4px solid rgba(255, 255, 255, 0.2);
            border-top: 4px solid white;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        .overlay {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            padding: 16px;
            background: linear-gradient(to top, rgba(0, 0, 0, 0.8) 30%, transparent 100%);
            z-index: 3;
            color: white;
            display: flex;
            flex-direction: column;
        }

        .profile-info {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }

        .user-info {
            display: flex;
            align-items: center;
        }

        .profile-pic {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid #fff;
            margin-right: 10px;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .userid {
            font-weight: bold;
            font-size: 1.1rem;
            color: white;
        }

        .nickname {
            font-size: 0.9rem;
            color: #aaa;
        }

        .follow-button {
            background-color: transparent;
            color: white;
            border: 2px solid white;
            padding: 6px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            transition: background-color 0.3s, color 0.3s;
            margin-left: 10px;
        }

        .follow-button:hover {
            background-color: white;
            color: black;
        }

        .text {
            margin: 6px 0;
            font-size: 1rem;
            cursor: pointer;
        }
        
        .text a {
            color: #38b1f7;
            text-decoration: none;
        }

        .time {
            font-size: 0.75rem;
            color: #777;
        }
        
        /* New interaction section styles */
        .new-interaction-section {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            align-items: center;
        }

        .interaction-item {
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
            user-select: none;
        }

        .interaction-icon {
            font-size: 30px;
            color: white;
            transition: color 0.3s;
        }
        
        .interaction-count {
            font-size: 1rem; 
            font-weight: bold;
        }
        
        .like-icon.liked {
            color: #ff4d4d;
        }

        #sound-indicator {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.6);
            padding: 15px;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        #sound-indicator.show {
            opacity: 1;
        }

        #sound-indicator .material-icons {
            font-size: 32px;
            color: white;
        }

        #snaps-title {
            position: fixed;
            top: 10px;
            left: 20px;
            z-index: 10;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 1px;
            padding: 5px 12px;
            border-radius: 12px;
        }

        #snaps-a {
            position: fixed;
            top: 10px;
            left: 85px;
            z-index: 10;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            font-size: 20px;
            letter-spacing: 1px;
            padding: 5px 12px;
            border-radius: 12px;
        }

        #snaps-p {
            position: fixed;
            top: 5px;
            right: 5px;
            z-index: 10;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            font-size: 15px;
            letter-spacing: 1px;
            padding: 5px 12px;
            border-radius: 12px;
        }
        
        /* New Comment System CSS */
        .comments-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: #1f1f1f;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
            transition: height 0.3s ease-in-out;
            z-index: 1000;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .comments-container.open {
            height: 80vh; 
        }
        
        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #333;
        }

        .comments-title {
            font-size: 1.2rem;
            font-weight: bold;
        }

        .close-comments {
            background: none;
            border: none;
            color: white;
            font-size: 2rem;
            cursor: pointer;
        }

        .comments-list {
            flex-grow: 1;
            padding: 15px;
            overflow-y: auto;
            /* display: flex; */
            flex-direction: column-reverse; /* Şərhləri yuxarıdan aşağı düzür */
        }
        
        .comment-item {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 12px;
        }
        
        .comment-main-content {
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        
        .comment-profile-pic {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            flex-shrink: 0;
        }
        
        .comment-content {
            display: flex;
            flex-direction: column;
        }
        
        .comment-text-bubble {
            background: #2b2b2b;
            border-radius: 18px;
            padding: 10px 15px;
            max-width: 90%;
            word-wrap: break-word;
            display: inline-block;
        }
        
        .comment-user {
            font-weight: bold;
            font-size: 0.95rem;
            margin-right: 5px;
        }
        
        .comment-text {
            font-size: 0.95rem;
            color: #fff;
        }
        
        .comment-actions {
            display: flex;
            gap: 15px;
            margin-left: 10px;
        }

        .reply-button {
            background: none;
            border: none;
            color: #aaa;
            font-size: 0.8rem;
            cursor: pointer;
            padding: 2px 5px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .replies-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-left: 42px;
            margin-top: 10px;
        }
        
        .replies-list .comment-item {
            margin-bottom: 0;
        }
        
        .comment-text a.reply-user,
        .comment-text a.hashtag {
            color: #38b1f7;
            text-decoration: none;
            font-weight: bold;
        }
        
        .comment-text a.reply-user:hover,
        .comment-text a.hashtag:hover {
            text-decoration: underline;
        }
        
        .comment-input-area {
            display: flex;
            align-items: center;
            padding: 10px 15px;
            border-top: 1px solid #333;
        }

        .comment-input {
            flex-grow: 1;
            background: #333;
            border: none;
            border-radius: 20px;
            padding: 10px 15px;
            color: white;
            font-size: 1rem;
        }

        .send-comment-btn {
            background: none;
            border: none;
            color: #38b1f7;
            font-size: 1.5rem;
            margin-left: 10px;
            cursor: pointer;
        }

    </style>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet" />
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200&icon_names=keyboard_arrow_down" />
</head>
<body>
    <div id="loader">
        <div class="spinner"></div>
    </div>
    <div id="app"></div>
    <div id="snaps-title">Snaps</div>
    <span id="snaps-a" class="material-symbols-outlined">keyboard_arrow_down</span>
    <div id="snaps-p">^_^</div>
    <div id="sound-indicator"><span class="material-icons">volume_up</span></div>

    <div id="comments-container" class="comments-container">
        <div class="comments-header">
            <span class="comments-title">Şərhlər</span>
            <button class="close-comments">&times;</button>
        </div>
        <div class="comments-list"></div>
        <div class="comment-input-area">
            <input type="text" class="comment-input" placeholder="Şərh yazın..." />
            <button class="send-comment-btn material-icons">send</button>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script>
        (function () {
            // Firebase configuration for reels
            const reelFirebaseConfig = {
                apiKey: "AIzaSyC6yWCYGtOkJoTOfZRoO8HGo-L_NKR9p5k",
                authDomain: "pasyak-reels.firebaseapp.com",
                projectId: "pasyak-reels",
                storageBucket: "pasyak-reels.firebasestorage.app",
                messagingSenderId: "635054499590",
                appId: "1:635054499590:web:7b1e9bc84f4b752317e087",
                measurementId: "G-FW0KJDLF4B"
            };
            const reelApp = firebase.initializeApp(reelFirebaseConfig, 'reelApp');
            const reelDb = reelApp.database();

            // Firebase configuration for user profiles
            const userFirebaseConfig = {
                apiKey: "AIzaSyBHRY6yGGT9qHV8df1OJXtmbQ7QxWu69ps",
                authDomain: "pasyak-user.firebaseapp.com",
                databaseURL: "https://pasyak-user-default-rtdb.firebaseio.com",
                projectId: "pasyak-user",
                storageBucket: "pasyak-user.firebasestorage.app",
                messagingSenderId: "898141218588",
                appId: "1:898141218588:web:f3477f39d96bceb2727cd9"
            };
            const userApp = firebase.initializeApp(userFirebaseConfig, 'userApp');
            const userDb = userApp.database();

            // Firebase configuration for follows
            const followsFirebaseConfig = {
                apiKey: "AIzaSyAZbtUw8id4yyXqrXtsf2FwuZmJ02qxit8",
                authDomain: "pasyak-follows.firebaseapp.com",
                databaseURL: "https://pasyak-follows-default-rtdb.firebaseio.com",
                projectId: "pasyak-follows",
                storageBucket: "pasyak-follows.firebasestorage.app",
                messagingSenderId: "571115478758",
                appId: "1:571115478758:web:9b45de3c9169083d9a2527",
                measurementId: "G-KHDDTM6FC9"
            };
            const followsApp = firebase.initializeApp(followsFirebaseConfig, 'followsApp');
            const followsDb = followsApp.database();

            // Firebase configuration for following
            const followingFirebaseConfig = {
                apiKey: "AIzaSyBA0gfZVLCnGV2Hli6BjEbq08SmLzFkshg",
                authDomain: "pasyak-following.firebaseapp.com",
                databaseURL: "https://pasyak-following-default-rtdb.firebaseio.com",
                projectId: "pasyak-following",
                storageBucket: "pasyak-following.firebasestorage.app",
                messagingSenderId: "538884111637",
                appId: "1:538884111637:web:c2c3532a1bda359aacbd1c"
            };
            const followingApp = firebase.initializeApp(followingFirebaseConfig, 'followingApp');
            const followingDb = followingApp.database();

            // Firebase configuration for comments (from user input)
            const commentsFirebaseConfig = {
                apiKey: "AIzaSyCqiOFuq6usZTZ4zsfd8LcCUdj1hP2j5cQ",
                authDomain: "reply-eb654.firebaseapp.com",
                projectId: "reply-eb654",
                storageBucket: "reply-eb654.firebasestorage.app",
                messagingSenderId: "292801573334",
                appId: "1:292801573334:web:2486813d8fe45865d0f477"
            };
            const commentsApp = firebase.initializeApp(commentsFirebaseConfig, 'commentsApp');
            const commentsDb = commentsApp.database();

            // DOM elements
            const app = document.getElementById('app');
            const loader = document.getElementById('loader');
            const soundIndicator = document.getElementById('sound-indicator');
            const soundIcon = soundIndicator.querySelector('span');
            const commentsContainer = document.getElementById('comments-container');
            const closeCommentsBtn = document.querySelector('.close-comments');
            const commentsList = document.querySelector('.comments-list');
            const commentInput = document.querySelector('.comment-input');
            const sendCommentBtn = document.querySelector('.send-comment-btn');

            // URL parameters
            // @ işarəsinin dəyişməməsi üçün parametrləri birbaşa URL sətirindən alırıq.
            const userFromUrl = window.location.search.match(/user=([^&]+)/)?.[1];
            const currentUser = userFromUrl || "anonim";
            const cleanCurrentUser = currentUser.startsWith('@') ? currentUser.substring(1) : currentUser;
            
            // Get current user's full name and profile picture from user database
            let currentUserName = cleanCurrentUser;
            let currentUserProfilePic = 'https://via.placeholder.com/48';

            // Global variables
            let reels = [];
            let activeIndex = 0;
            let isAnimating = false;
            let allVideosSoundOn = true;
            const fallbackVideo = "https://interactive-examples.mdn.mozilla.net/media/cc0-videos/flower.webm";
            let indicatorTimeout = null;
            let touchStartY = null;
            let activePostId = null;
            let activeCommentId = null; // Cavab veriləcək şərhin ID-si
            
            // Cache for user profiles and follow status
            const userProfileCache = {};
            const userFollowStatusCache = {};

            // Function to fetch user profile from the user database
            async function fetchUserProfile(username) {
                const cleanUsername = username.startsWith('@') ? username.substring(1) : username;
                if (userProfileCache[cleanUsername]) {
                    return userProfileCache[cleanUsername];
                }
                try {
                    const snapshot = await userDb.ref(`Users/${cleanUsername}`).once('value');
                    const profileData = snapshot.val();
                    if (profileData) {
                        const parsedData = JSON.parse(profileData);
                        const profilePicUrl = parsedData[2].trim();
                        userProfileCache[cleanUsername] = profilePicUrl;
                        return profilePicUrl;
                    }
                } catch (e) {
                    console.error(`Error fetching profile for user ${cleanUsername}:`, e);
                }
                return 'https://via.placeholder.com/48';
            }
            
            // Function to fetch user name
            async function fetchUserName(username) {
                const cleanUsername = username.startsWith('@') ? username.substring(1) : username;
                try {
                    const snapshot = await userDb.ref(`Users/${cleanUsername}`).once('value');
                    const profileData = snapshot.val();
                    if (profileData) {
                        const parsedData = JSON.parse(profileData);
                        return parsedData[0]; // full name
                    }
                } catch (e) {
                    console.error(`Error fetching name for user ${cleanUsername}:`, e);
                }
                return cleanUsername;
            }

            // Function to check if the current user is already following the reel user
            async function isFollowing(reelUserNickname) {
                const cleanReelUserNickname = reelUserNickname.startsWith('@') ? reelUserNickname.substring(1) : reelUserNickname;
                const cleanCurrentUser = currentUser.startsWith('@') ? currentUser.substring(1) : currentUser;

                if (cleanReelUserNickname === cleanCurrentUser) {
                    return true;
                }
                if (userFollowStatusCache[cleanReelUserNickname] !== undefined) {
                    return userFollowStatusCache[cleanReelUserNickname];
                }
                try {
                    let snapshot = await followingDb.ref(cleanCurrentUser).child(cleanReelUserNickname).once('value');
                    
                    if (!snapshot.exists()) {
                        snapshot = await followingDb.ref(cleanCurrentUser).child(`@${cleanReelUserNickname}`).once('value');
                    }

                    const isFollowed = snapshot.exists();
                    userFollowStatusCache[cleanReelUserNickname] = isFollowed;
                    return isFollowed;
                } catch (e) {
                    console.error("Error checking follow status:", e);
                    return false;
                }
            }

            function shuffleArray(array) {
                for (let i = array.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [array[i], array[j]] = [array[j], array[i]];
                }
                return array;
            }
            
            reelDb.ref('likes').on('value', (snapshot) => {
                const likesData = snapshot.val() || {};
                reels.forEach(reel => {
                    const postLikes = likesData[reel.postId] || {};
                    const likedByUser = postLikes.users && postLikes.users[currentUser];

                    if (likedByUser) {
                        reel.likeIcon.classList.add('liked');
                    } else {
                        reel.likeIcon.classList.remove('liked');
                    }

                    const likeCount = postLikes.count || 0;
                    reel.likeCount.textContent = likeCount;
                });
            });

            // Verilənlərin yüklənməsini gözləyən əsas hissə
            async function initializeApp() {
                const postsData = await reelDb.ref('reels').once('value').then(snapshot => snapshot.val() || {});
                const likesData = await reelDb.ref('likes').once('value').then(snap => snap.val() || {});
                
                currentUserName = await fetchUserName(cleanCurrentUser);
                currentUserProfilePic = await fetchUserProfile(cleanCurrentUser);

                let postIds = Object.keys(postsData);
                postIds = shuffleArray(postIds);

                const loadedReels = [];
                for (const postId of postIds) {
                    let post;
                    try {
                        post = JSON.parse(postsData[postId]);
                    } catch (e) {
                        console.error(`Error parsing JSON for reel ID ${postId}:`, e);
                        continue;
                    }

                    const profilePicUrl = await fetchUserProfile(post.nickname);
                    post.profile = profilePicUrl;
                    
                    const isFollowed = await isFollowing(post.nickname);
                    const isLiked = likesData[postId] && likesData[postId].users && likesData[postId].users[currentUser];
                    
                    loadedReels.push({ id: postId, isFollowed, isLiked, ...post });
                }
                
                while(app.firstChild) {
                    app.removeChild(app.firstChild);
                }
                reels = [];

                loadedReels.forEach(post => {
                    const newReel = createReel(post);
                    app.appendChild(newReel.element);
                    reels.push(newReel);
                    
                    reelDb.ref(`likes/${post.id}/count`).once('value').then(likeSnap => {
                        const count = likeSnap.val() || 0;
                        newReel.likeCount.textContent = count;
                    });
                    
                    commentsDb.ref(`comments/${post.id}`).on('value', async (snap) => {
                        let totalComments = 0;
                        const commentsData = snap.val();
                        if (commentsData) {
                            for (const commentId in commentsData) {
                                totalComments++; // Count the main comment
                                if (commentsData[commentId].replies) {
                                    totalComments += Object.keys(commentsData[commentId].replies).length; // Add reply count
                                }
                            }
                        }
                        newReel.commentCountElement.textContent = totalComments;
                    });
                });

                if (reels.length > 0) {
                    activeIndex = 0;
                    const activeReel = reels[activeIndex];
                    activeReel.element.classList.add('active');
                    activeReel.element.style.transform = 'translateY(0)';
                    activeReel.element.style.opacity = '1';

                    playActiveVideo(activeIndex);
                    preloadVideos();
                    
                    const urlParams = new URLSearchParams(window.location.search);
                    if (urlParams.get('reply') === 'true' && urlParams.get('post') && urlParams.get('post') === reels[activeIndex].postId) {
                        openComments(reels[activeIndex].postId);
                    }
                }

                loader.style.display = 'none';
            }

            initializeApp();

            followingDb.ref(cleanCurrentUser).on('value', async (snapshot) => {
                const followingData = snapshot.val() || {};
                const followingUsers = Object.keys(followingData);
                
                for (const user in userFollowStatusCache) {
                    userFollowStatusCache[user] = followingUsers.includes(user);
                }
                
                reels.forEach(reel => {
                    const cleanNickname = reel.userNickname.startsWith('@') ? reel.userNickname.substring(1) : reel.userNickname;
                    const followButton = reel.followButton;
                    if (followButton) {
                        if (cleanPostNickname === cleanCurrentUser || followingUsers.includes(cleanNickname) || followingUsers.includes(`@${cleanNickname}`)) {
                            followButton.style.display = 'none';
                        } else {
                            followButton.style.display = 'block';
                        }
                    }
                });
            });

            function showSoundIndicator(muted) {
                clearTimeout(indicatorTimeout);
                soundIcon.textContent = muted ? 'volume_off' : 'volume_up';
                soundIndicator.classList.add('show');
                indicatorTimeout = setTimeout(() => {
                    soundIndicator.classList.remove('show');
                }, 1000);
            }
            
            function preloadVideos() {
                for (let i = 0; i < reels.length; i++) {
                    const video = reels[i].video;
                    video.preload = 'auto'; 
                }
            }

            function playActiveVideo(index) {
                const reel = reels[index];
                if (reel && reel.video) {
                    reel.video.addEventListener('loadeddata', () => {
                        reel.video.style.display = 'block';
                        if(reel.loader) reel.loader.style.display = 'none';
                        
                        reel.video.muted = !allVideosSoundOn;
                        reel.video.play().catch(e => {
                            console.error("Video avtomatik başlamadı, səbəb: ", e);
                            if (e.name === 'NotAllowedError') {
                                reel.video.muted = true;
                                reel.video.play().then(() => showSoundIndicator(true));
                            }
                        });
                    }, { once: true });
                    
                    if (reel.video.readyState < 2) {
                        reel.video.style.display = 'none';
                        if(reel.loader) reel.loader.style.display = 'block';
                    } else {
                        reel.video.style.display = 'block';
                        if(reel.loader) reel.loader.style.display = 'none';
                        reel.video.muted = !allVideosSoundOn;
                        reel.video.play();
                    }
                }
            }

            function pauseInactiveVideos(activeIndex) {
                reels.forEach((r, i) => {
                    if (i !== activeIndex && r.video && !r.video.paused) {
                        r.video.pause();
                        r.video.currentTime = 0;
                        r.video.muted = true;
                    }
                });
            }

            function handleLikeClick(postId) {
                const likeUserRef = reelDb.ref(`likes/${postId}/users/${currentUser}`);
                const likeCountRef = reelDb.ref(`likes/${postId}/count`);

                likeUserRef.once('value').then(snap => {
                    if (snap.exists()) {
                        likeUserRef.remove();
                        likeCountRef.transaction(currentCount => (currentCount || 1) - 1);
                    } else {
                        likeUserRef.set(true);
                        likeCountRef.transaction(currentCount => (currentCount || 0) + 1);
                    }
                }).catch(e => {
                    console.error("Like əməliyyatı uğursuz oldu: ", e);
                });
            }

            async function handleFollowClick(reelUserNickname) {
                const followerUsername = cleanCurrentUser;
                const followedUsername = reelUserNickname.startsWith('@') ? reelUserNickname.substring(1) : reelUserNickname;

                if (followerUsername === followedUsername) {
                    console.log("Kendi kendinizi takip edemezsiniz.");
                    return;
                }

                try {
                    const isFollowed = await isFollowing(followedUsername);
                    if (!isFollowed) {
                        const followsRef = followsDb.ref(followedUsername);
                        const followerRef = followsRef.child(followerUsername);
                        const followCountRef = followsRef.child('follow');

                        const followingRef = followingDb.ref(followerUsername);
                        const followedRef = followingRef.child(followedUsername);
                        const followingCountRef = followingRef.child('following');
                        
                        await followerRef.set("+");
                        await followCountRef.transaction(currentCount => (parseInt(currentCount) || 0) + 1);
                        
                        await followedRef.set("+");
                        await followingCountRef.transaction(currentCount => (parseInt(currentCount) || 0) + 1);

                        userFollowStatusCache[followedUsername] = true;
                        
                        const followButton = document.querySelector(`.follow-button[data-nickname="${reelUserNickname}"]`);
                        if (followButton) followButton.style.display = 'none';

                        console.log(`User ${followerUsername} is now following ${followedUsername}.`);
                    } else {
                        console.log(`User ${followerUsername} is already following ${followedUsername}. No action needed.`);
                    }
                } catch (e) {
                    console.error("Follow operation failed:", e);
                }
            }
            
            function createReel(post) {
                const reel = document.createElement('div');
                reel.className = 'reel';
                
                const loader = document.createElement('div');
                loader.className = 'reel-loader';
                reel.appendChild(loader);

                const video = document.createElement('video');
                video.src = post.video && post.video.trim() ? post.video.trim() : fallbackVideo;
                video.loop = true;
                video.playsInline = true;
                video.muted = !allVideosSoundOn;
                video.preload = 'auto';
                video.style.display = 'none';

                video.onerror = () => {
                    console.warn(`Video yüklənmədi: ${video.src}. Fallback tətbiq olunur.`);
                    video.src = fallbackVideo;
                    video.load();
                };

                video.addEventListener('click', () => {
                    allVideosSoundOn = !allVideosSoundOn;
                    reels.forEach(r => {
                        r.video.muted = !allVideosSoundOn;
                    });
                    showSoundIndicator(!allVideosSoundOn);
                });

                reel.appendChild(video);

                const overlay = document.createElement('div');
                overlay.className = 'overlay';

                const profileInfo = document.createElement('div');
                profileInfo.className = 'profile-info';

                const userInfo = document.createElement('div');
                userInfo.className = 'user-info';
                
                const profilePic = document.createElement('img');
                profilePic.className = 'profile-pic';
                profilePic.src = post.profile || 'https://via.placeholder.com/48';

                const userDetails = document.createElement('div');
                userDetails.className = 'user-details';
                const userid = document.createElement('div');
                userid.className = 'userid';
                userid.textContent = post.user;
                const nickname = document.createElement('div');
                nickname.className = 'nickname';
                nickname.textContent = post.nickname;

                userDetails.appendChild(userid);
                userDetails.appendChild(nickname);
                userInfo.appendChild(profilePic);
                userInfo.appendChild(userDetails);

                profileInfo.appendChild(userInfo);

                const followButton = document.createElement('button');
                followButton.className = 'follow-button';
                followButton.textContent = 'Takib Et';
                followButton.setAttribute('data-nickname', post.nickname);
                
                isFollowing(post.nickname).then(isFollowed => {
                    const cleanPostNickname = post.nickname.startsWith('@') ? post.nickname.substring(1) : post.nickname;
                    if (cleanPostNickname === cleanCurrentUser || isFollowed) {
                        followButton.style.display = 'none';
                    } else {
                        followButton.style.display = 'block';
                    }
                });

                followButton.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleFollowClick(post.nickname);
                });

                profileInfo.appendChild(followButton);

                const text = document.createElement('div');
                text.className = 'text';

                const fullText = (post.text || '').replace(/#(\w+)/g, '<a href="#">#$1</a>');
                const shortText = fullText.split(' ').slice(0, 3).join(' ') + '...';
                
                text.innerHTML = shortText;
                let isExpanded = false;

                text.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (fullText.split(' ').length > 3) {
                        if (isExpanded) {
                            text.innerHTML = fullText;
                        } else {
                            text.innerHTML = shortText;
                        }
                        isExpanded = !isExpanded;
                    }
                });

                const time = document.createElement('div');
                time.className = 'time';
                time.textContent = post.time || '';
                
                const newInteractionSection = document.createElement('div');
                newInteractionSection.className = 'new-interaction-section';

                const likeSection = document.createElement('div');
                likeSection.className = 'interaction-item';
                const likeIcon = document.createElement('span');
                likeIcon.className = 'material-icons interaction-icon like-icon';
                likeIcon.textContent = 'favorite';
                
                if (post.isLiked) {
                    likeIcon.classList.add('liked');
                }

                const likeCount = document.createElement('span');
                likeCount.className = 'interaction-count';
                likeCount.textContent = post.likesCount || 0;

                likeSection.appendChild(likeIcon);
                likeSection.appendChild(likeCount);

                likeSection.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    handleLikeClick(post.id);
                });

                const commentSection = document.createElement('div');
                commentSection.className = 'interaction-item';
                const commentIcon = document.createElement('span');
                commentIcon.className = 'material-icons interaction-icon';
                commentIcon.textContent = 'comment';
                
                commentIcon.addEventListener('click', e => {
                    e.preventDefault();
                    e.stopPropagation();
                    openComments(post.id);
                });
                
                const commentCount = document.createElement('span');
                commentCount.className = 'interaction-count';
                commentCount.textContent = post.commentCount || 0;
                
                commentSection.appendChild(commentIcon);
                commentSection.appendChild(commentCount);
                
                newInteractionSection.appendChild(likeSection);
                newInteractionSection.appendChild(commentSection);
                
                overlay.appendChild(profileInfo);
                overlay.appendChild(text);
                overlay.appendChild(time);
                overlay.appendChild(newInteractionSection);
                
                reel.appendChild(overlay);

                return { element: reel, video, likeIcon, likeCount, postId: post.id, userNickname: post.nickname, followButton: followButton, loader: loader, commentCountElement: commentCount };
            }

            function setActiveReel(newIndex) {
                if (isAnimating || newIndex === activeIndex || newIndex < 0 || newIndex >= reels.length) return;

                isAnimating = true;
                
                commentsContainer.classList.remove('open');
                if (window.location.search.includes('reply=true')) {
                    closeComments();
                }

                const currentReel = reels[activeIndex];
                const nextReel = reels[newIndex];

                pauseInactiveVideos(newIndex);

                currentReel.element.style.transform = (newIndex > activeIndex) ? 'translateY(-100%)' : 'translateY(100%)';
                currentReel.element.style.opacity = '0';
                currentReel.element.style.zIndex = '1';
                currentReel.element.classList.remove('active');

                nextReel.element.style.transform = 'translateY(0)';
                nextReel.element.style.opacity = '1';
                nextReel.element.style.zIndex = '2';
                nextReel.element.classList.add('active');

                activeIndex = newIndex;

                setTimeout(() => {
                    isAnimating = false;
                    playActiveVideo(activeIndex);
                }, 500);
            }

            function handleScroll(direction) {
                if (isAnimating) return;

                if (direction === 'down' && activeIndex < reels.length - 1) {
                    setActiveReel(activeIndex + 1);
                } else if (direction === 'up' && activeIndex > 0) {
                    setActiveReel(activeIndex - 1);
                }
            }

            let wheelTimeout = null;
            window.addEventListener('wheel', e => {
                if (!isAnimating) {
                    clearTimeout(wheelTimeout);
                    wheelTimeout = setTimeout(() => {
                        if (e.deltaY > 0) {
                            handleScroll('down');
                        } else if (e.deltaY < 0) {
                            handleScroll('up');
                        }
                    }, 80);
                }
            });

            app.addEventListener('touchstart', e => {
                if (!isAnimating && e.touches.length === 1) {
                    touchStartY = e.touches[0].clientY;
                }
            });

            app.addEventListener('touchend', e => {
                touchStartY = null;
            });

            app.addEventListener('touchmove', e => {
                if (!isAnimating && touchStartY !== null) {
                    const yDiff = touchStartY - e.touches[0].clientY;
                    if (Math.abs(yDiff) > 50) {
                        if (yDiff > 0) {
                            handleScroll('down');
                        } else if (yDiff < 0) {
                            handleScroll('up');
                        }
                    }
                }
            });
            
            // Yeni Şərh Sistemi Məntiqi 
            let commentsDbRef = null; 
            let commentAddedListenerAttached = false;

            function closeComments() { 
                commentsContainer.classList.remove('open'); 
                if (commentsDbRef) { 
                    commentsDbRef.off(); 
                    commentsDbRef = null; 
                } 
                commentAddedListenerAttached = false;
                commentsList.innerHTML = '';
                
                // URL-dəki 'reply' və 'post' parametrlərini silən yeni məntiq
                const searchString = window.location.search;
                let userParam = null;
                if (searchString.includes('user=')) {
                    userParam = searchString.match(/user=([^&]+)/)?.[1];
                }
                
                let newUrl = window.location.pathname;
                if (userParam) {
                    newUrl += `?user=${userParam}`;
                }
                history.replaceState({}, '', newUrl);
            } 
            
            closeCommentsBtn.addEventListener('click', closeComments); 

            sendCommentBtn.addEventListener('click', sendComment); 
            commentInput.addEventListener('keydown', (e) => { 
                if (e.key === 'Enter') { 
                    sendComment(); 
                }
            }); 
            
            window.addEventListener('popstate', () => {
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('reply') !== 'true' && commentsContainer.classList.contains('open')) {
                    closeComments();
                }
            });

            async function addCommentToDOM(comment, parentCommentId = null) {
                const commentElement = document.createElement('div');
                commentElement.className = `comment-item ${parentCommentId ? 'reply-item' : ''}`;
                commentElement.dataset.commentId = comment.id;

                const userProfilePic = await fetchUserProfile(comment.user);
                const userName = await fetchUserName(comment.user);

                let formattedText = comment.text;
                formattedText = formattedText.replace(/#(\w+)/g, '<a href="#" class="hashtag">#$1</a>');
                formattedText = formattedText.replace(/@(\w+)/g, '<a href="#" class="reply-user">@$1</a>');
                
                commentElement.innerHTML = `
                    <div class="comment-main-content">
                        <img src="${userProfilePic}" class="comment-profile-pic" alt="${userName}" />
                        <div class="comment-text-bubble">
                            <span class="comment-user">${userName}</span>
                            <span class="comment-text">${formattedText}</span>
                        </div>
                    </div>
                `;

                if (!parentCommentId) {
                    const actionsHtml = `<div class="comment-actions">
                        <button class="reply-button">
                            <span class="reply-text">Reply</span>
                            <span class="reply-count"></span>
                        </button>
                    </div>`;
                    
                    commentElement.innerHTML += actionsHtml;

                    const repliesList = document.createElement('div');
                    repliesList.className = 'replies-list';
                    repliesList.style.display = 'none';
                    commentElement.appendChild(repliesList);

                    const replyButton = commentElement.querySelector('.reply-button');
                    const replyCountSpan = commentElement.querySelector('.reply-count');
                    
                    commentsDb.ref(`comments/${activePostId}/${comment.id}/replies`).on('value', snap => {
                        const count = snap.numChildren();
                        if (count > 0) {
                            replyCountSpan.textContent = `+${count}`;
                            replyCountSpan.style.display = 'inline';
                        } else {
                            replyCountSpan.style.display = 'none';
                        }
                    });

                    replyButton.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        if (repliesList.style.display === 'none' || repliesList.innerHTML === '') {
                            repliesList.style.display = 'flex';
                            repliesList.innerHTML = '';
                            
                            const repliesSnapshot = await commentsDb.ref(`comments/${activePostId}/${comment.id}/replies`).once('value');
                            const replies = repliesSnapshot.val();
                            if (replies) {
                                const repliesArray = Object.keys(replies).map(key => ({ id: key, ...replies[key] }));
                                repliesArray.sort((a, b) => a.timestamp - b.timestamp);
                                for (const reply of repliesArray) {
                                    await addCommentToDOM(reply, comment.id);
                                }
                            }
                        } else {
                            repliesList.style.display = 'none';
                        }
                    });

                } else {
                    commentElement.classList.add('reply-item');
                }

                commentElement.querySelector('.comment-text-bubble').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const replyText = `@${comment.user} `;
                    commentInput.value = replyText;
                    commentInput.focus();
                    activeCommentId = comment.id;
                });
                
                if (parentCommentId) {
                    const parentCommentElement = commentsList.querySelector(`.comment-item[data-comment-id="${parentCommentId}"]`);
                    if (parentCommentElement) {
                        const repliesList = parentCommentElement.querySelector('.replies-list');
                        if (repliesList) {
                            repliesList.appendChild(commentElement);
                        }
                    }
                } else {
                    commentsList.prepend(commentElement);
                }
            }

            async function openComments(postId) { 
                activePostId = postId; 
                commentsContainer.classList.add('open'); 
    
                const newUrl = `${window.location.pathname}?user=${currentUser}&reply=true&post=${postId}`; 
                history.pushState({ postId: postId, user: currentUser }, '', newUrl); 
    
                commentsList.innerHTML = ''; 
    
                const commentsSnapshot = await commentsDb.ref(`comments/${postId}`).once('value');
                const comments = commentsSnapshot.val();
                
                if (comments) {
                    const commentsArray = Object.keys(comments).map(key => ({ id: key, ...comments[key] }));
                    commentsArray.sort((a, b) => b.timestamp - a.timestamp);
                    
                    for (const comment of commentsArray) {
                        await addCommentToDOM(comment);
                    }
                }

                if (!commentAddedListenerAttached) {
                    commentsDbRef = commentsDb.ref(`comments/${postId}`);
                    commentsDbRef.on('child_added', async (snapshot) => {
                         const newComment = { id: snapshot.key, ...snapshot.val() };
                         if (!commentsList.querySelector(`[data-comment-id="${newComment.id}"]`)) {
                             await addCommentToDOM(newComment);
                         }
                     });
                     commentAddedListenerAttached = true;
                }
            }

            async function sendComment() { 
                const commentText = commentInput.value.trim(); 
                if (commentText === "" || !activePostId) return; 
                
                const newComment = { 
                    user: cleanCurrentUser, 
                    text: commentText, 
                    timestamp: Date.now() 
                };

                const replyToUserMatch = commentText.match(/^@(\w+)/);
                if (replyToUserMatch && activeCommentId) {
                    const replyRef = commentsDb.ref(`comments/${activePostId}/${activeCommentId}/replies`).push();
                    await replyRef.set(newComment);
                    activeCommentId = null;
                } else {
                    const newCommentRef = commentsDb.ref(`comments/${activePostId}`).push();
                    await newCommentRef.set(newComment);
                }
                
                commentInput.value = ''; 
            }
        })();
    </script>
</body>
</html>
