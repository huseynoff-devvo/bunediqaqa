<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bütün Postlar (Canlı)</title>
  <style>
    @import url('https://fonts.googleapis.com/icon?family=Material+Icons');

    /* GLOBAL RESET FOR FOCUS AND TAP HIGHLIGHT */
    * {
      -webkit-tap-highlight-color: transparent;
    }
    *:focus,
    *:active,
    *:focus-visible {
      outline: none !important;
      box-shadow: none !important;
    }

    body {
      background: #181818;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 5px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    #loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #181818;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
    }

    .spinner {
      border: 3px solid #333;
      border-top: 3px solid white;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    #posts-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      width: 100%;
      max-width: 600px;
    }

    .post {
      background: #1e1e1e;
      border-radius: 10px;
      padding: 10px;
      display: flex;
      flex-direction: column;
      overflow: hidden;
      position: relative;
    }

    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
      position: relative;
    }

    .profile-pic {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 8px;
    }

    .username-box {
      display: flex;
      flex-direction: column;
    }

    .userid {
      font-weight: bold;
      font-size: 0.9rem;
      display: flex;
      align-items: center;
    }

    .status-badge {
      width: 16px;
      height: 16px;
      margin-left: 5px;
    }

    .nickname {
      font-size: 0.7rem;
      color: #aaa;
    }

    .post-text {
      margin: 8px 0;
      font-size: 0.8rem;
    }

    .post-image {
      width: 100%;
      height: auto;
      border-radius: 8px;
      margin-top: 5px;
    }

    .post-time {
      font-size: 0.7rem;
      color: #aaa;
      text-align: right;
      margin-top: 5px;
    }

    /* Beyenen sexsler siyahisi stilleri */
    .liked-users-summary {
      font-size: 0.7rem;
      margin-top: 5px;
      color: #ccc;
      cursor: pointer;
      user-select: none;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .liked-users-list {
      font-size: 0.7rem;
      margin-top: 5px;
      color: #ddd;
      background: transparent;
      border-radius: 5px;
      padding: 5px 10px;
      max-height: 80px;
      overflow-y: auto;
      display: none;
      box-shadow: none;
    }
  </style>
</head>
<body>
  <div id="loader">
    <div class="spinner"></div>
    <p style="color:white; margin-top: 15px;"></p>
  </div>

  <div id="posts-grid" style="display:none;"></div>
  
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC_wr_ji3crAVEmRwbHmJ0YJfx46B_as2w",
      authDomain: "pasyakaaz.firebaseapp.com",
      projectId: "pasyakaaz",
      storageBucket: "pasyakaaz.appspot.com",
      messagingSenderId: "289629756800",
      appId: "1:289629756800:web:f7a6f00fcce2b1eb28b565"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const postsContainer = document.getElementById("posts-grid");

    const urlParams = new URLSearchParams(window.location.search);
    const currentUser = urlParams.get("user")?.trim() || "anonim";
    const showOnlyMyPosts = urlParams.get("myPosts") === "true";
    const newProfileURL = urlParams.get("profile")?.trim() || null;

    let postDataCache = {};
    let likeCache = {}; // We need this to get liked users

    // Separate Firebase configs for tick and premium
    const tickFirebaseConfig = {
      apiKey: "AIzaSyA2RNLGS-qUkhq6zNGtoUMTXJ3jNTfuHoE",
      authDomain: "pasyak-tick.firebaseapp.com",
      databaseURL: "https://pasyak-tick-default-rtdb.firebaseio.com",
      projectId: "pasyak-tick",
      storageBucket: "pasyak-tick.firebasestorage.app",
      messagingSenderId: "379214418412",
      appId: "1:379214418412:web:904dc0357ecd31f54a70c9",
      measurementId: "G-DW00VF06NR"
    };
    const premiumFirebaseConfig = {
      apiKey: "AIzaSyByZEbmw0w1Q5U1LfOrFsjCpd9CXzwyHyc",
      authDomain: "pasyak-premium.firebaseapp.com",
      databaseURL: "https://pasyak-premium-default-rtdb.firebaseio.com",
      projectId: "pasyak-premium",
      storageBucket: "pasyak-premium.firebasestorage.app",
      messagingSenderId: "662922654975",
      appId: "1:662922654975:web:54b78968d4cccba65f88ca",
      measurementId: "G-QDTFGFYXKK"
    };

    const tickApp = firebase.initializeApp(tickFirebaseConfig, "tickApp");
    const premiumApp = firebase.initializeApp(premiumFirebaseConfig, "premiumApp");
    const tickDb = tickApp.database();
    const premiumDb = premiumApp.database();

    let tickUsers = {};
    let premiumUsers = {};

    function loadStatusData() {
      tickDb.ref("tick").on("value", (snapshot) => {
        tickUsers = snapshot.val() || {};
        renderAllPosts();
      });

      premiumDb.ref("premium").on("value", (snapshot) => {
        premiumUsers = snapshot.val() || {};
        renderAllPosts();
      });
    }

    function getStatusBadge(nickname) {
      const cleanNickname = nickname.startsWith('@') ? nickname.substring(1) : nickname;
      const isTick = tickUsers[cleanNickname] === "+";
      const isPremium = premiumUsers[cleanNickname] === "+";
      
      if (isTick && isPremium) {
        return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/premium-tick_ne5yjz.png";
      } else if (isTick) {
        return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/tik_tiozjv.png";
      } else if (isPremium) {
        return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/premium_aomgkl.png";
      }
      return null;
    }

    function renderPost(postId, data) {
      const cleanCurrentUser = currentUser.startsWith('@') ? currentUser.substring(1) : currentUser;
      const cleanPostNickname = data.nickname.startsWith('@') ? data.nickname.substring(1) : data.nickname;
      
      if (showOnlyMyPosts && cleanPostNickname !== cleanCurrentUser) {
        return null;
      }

      if (newProfileURL && cleanPostNickname === cleanCurrentUser && data.profile !== newProfileURL) {
        data.profile = newProfileURL;
        db.ref(`posts/${postId}`).set(JSON.stringify(data));
      }

      const postEl = document.createElement("div");
      postEl.className = "post";
      postEl.id = "post_" + postId;

      const header = document.createElement("div");
      header.className = "post-header";

      const img = document.createElement("img");
      img.className = "profile-pic";
      img.src = data.profile || "https://via.placeholder.com/36?text=?";

      const userBox = document.createElement("div");
      userBox.className = "username-box";

      const userId = document.createElement("div");
      userId.className = "userid";
      userId.textContent = data.user || "Anonim";
      
      const statusBadgeUrl = getStatusBadge(data.nickname);
      if (statusBadgeUrl) {
        const statusBadgeImg = document.createElement("img");
        statusBadgeImg.className = "status-badge";
        statusBadgeImg.src = statusBadgeUrl;
        userId.appendChild(statusBadgeImg);
      }

      const nickname = document.createElement("div");
      nickname.className = "nickname";
      const displayNickname = data.nickname.startsWith('@') ? data.nickname : `@${data.nickname}`;
      nickname.textContent = displayNickname;

      userBox.appendChild(userId);
      userBox.appendChild(nickname);
      header.appendChild(img);
      header.appendChild(userBox);
      
      postEl.appendChild(header);

      if (data.image) {
        const image = document.createElement("img");
        image.className = "post-image";
        image.src = data.image.replace(/\\/g, '').trim();
        postEl.appendChild(image);
      }

      if (data.text) {
        const text = document.createElement("div");
        text.className = "post-text";
        text.textContent = data.text;
        postEl.appendChild(text);
      }
      
      // Bəyənən istifadəçilərin siyahısı
      const likedUsersSummary = document.createElement("div");
      likedUsersSummary.className = "liked-users-summary";

      const likedUsersList = document.createElement("div");
      likedUsersList.className = "liked-users-list";

      function updateLikedUsers() {
        const usersObj = likeCache[postId] || {};
        const users = Object.keys(usersObj);
        const usersToDisplay = users.slice(0, 2).map(u => `${u}`).join(", ");

        if (users.length === 0) {
          likedUsersSummary.textContent = "";
          likedUsersList.style.display = "none";
        } else if (users.length <= 2) {
          likedUsersSummary.innerHTML = `${usersToDisplay} bəyəndi`;
          likedUsersList.style.display = "none";
        } else {
          likedUsersSummary.innerHTML = `${usersToDisplay} bəyəndi <span style="color:#ccc; cursor:pointer;">... (kliklə)</span>`;
          likedUsersList.innerHTML = "";
          users.slice(2).forEach(u => {
            const d = document.createElement("div");
            d.textContent = u;
            likedUsersList.appendChild(d);
          });
          likedUsersSummary.querySelector("span").onclick = () => {
            if (likedUsersList.style.display === "none" || likedUsersList.style.display === "") {
              likedUsersList.style.display = "block";
              likedUsersSummary.querySelector("span").textContent = "(bağla)";
            } else {
              likedUsersList.style.display = "none";
              likedUsersSummary.querySelector("span").textContent = "... (kliklə)";
            }
          };
        }
      }

      updateLikedUsers();
      postEl.appendChild(likedUsersSummary);
      postEl.appendChild(likedUsersList);
      
      const time = document.createElement("div");
      time.className = "post-time";
      time.textContent = data.time || "";
      postEl.appendChild(time);

      return postEl;
    }

    function renderAllPosts() {
      postsContainer.innerHTML = "";
      let postIds = Object.keys(postDataCache);
      
      const cleanCurrentUser = currentUser.startsWith('@') ? currentUser.substring(1) : currentUser;
      
      if (showOnlyMyPosts) {
        postIds = postIds.filter(postId => {
          const post = postDataCache[postId];
          const cleanPostNickname = post.nickname.startsWith('@') ? post.nickname.substring(1) : post.nickname;
          return cleanPostNickname === cleanCurrentUser;
        });
      }

      postIds.sort((a, b) => {
        const aTime = postDataCache[a].time ? new Date(postDataCache[a].time) : null;
        const bTime = postDataCache[b].time ? new Date(postDataCache[b].time) : null;
        if (aTime && bTime) {
          return bTime.getTime() - aTime.getTime();
        } else {
          return b.localeCompare(a);
        }
      });
      
      postIds.forEach(postId => {
        const data = postDataCache[postId];
        const postEl = renderPost(postId, data);
        if (postEl) {
          postsContainer.appendChild(postEl);
        }
      });
    }

    function loadLivePosts() {
      db.ref("likes").on("value", (likesSnap) => {
        likeCache = likesSnap.val() || {};
        renderAllPosts();
      });

      const postsRef = db.ref("posts");
      postsRef.on("child_added", (snap) => {
        try {
          const postId = snap.key;
          const data = JSON.parse(snap.val());
          postDataCache[postId] = data;
          renderAllPosts();
        } catch (e) {
          console.warn("Post əlavə olunarkən xəta:", snap.key);
        }
      });
      postsRef.on("child_changed", (snap) => {
        try {
          const postId = snap.key;
          const data = JSON.parse(snap.val());
          postDataCache[postId] = data;
          renderAllPosts();
        } catch (e) {
          console.warn("Post dəyişilərkən xəta:", snap.key);
        }
      });
      postsRef.on("child_removed", (snap) => {
        const postId = snap.key;
        delete postDataCache[postId];
        const el = document.getElementById("post_" + postId);
        if (el) el.remove();
      });
    }

    loadStatusData();
    loadLivePosts();

    setTimeout(() => {
      document.getElementById("loader").style.display = "none";
      document.getElementById("posts-grid").style.display = "grid";
    }, 3000);
  </script>
</body>
</html>
