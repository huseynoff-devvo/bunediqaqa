<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bildirişlər</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: "Inter", sans-serif;
            background-color: #101010; /* Darker background */
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 0; /* Padding-i 0 olaraq təyin edin ki, yükləmə overlay-ı tam ekranı əhatə etsin */
            box-sizing: border-box;
            color: #e0e0e0; /* Light text for dark mode */
        }
        .container {
            background-color: #101010; /* Slightly lighter dark for container */
            border-radius: 12px;
            /* box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); Softer, but noticeable shadow */
            padding: 1.5rem; /* Slightly less padding for mobile */
            width: 100%;
            max-width: 768px;
            box-sizing: border-box;
            /* border: 1px solid #383838; Slightly softer border */
        }

        /* Mobile adjustments for container padding */
        @media (min-width: 640px) { /* Small screens and up */
            .container {
                padding: 2.5rem; /* Original padding for larger screens */
            }
        }

        .notification-item {
            display: flex;
            align-items: flex-start; /* Align items to the top for better content flow */
            padding: 0.5rem; /* Less internal padding for items on mobile */
            background-color: #181818; /* Darker notification item background */
            border-radius: 10px; /* Rounded corners for items */
            margin-bottom: 0.75rem; /* Less spacing between items on mobile */
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.25); /* Subtle item shadow */
            border: 1px solid #333; /* Soft border for items */
            flex-direction: column; /* Stack items vertically on mobile */
        }

        /* Desktop adjustments for notification item */
        @media (min-width: 640px) {
            .notification-item {
                padding: 1.25rem; /* Original padding for larger screens */
                margin-bottom: 0.85rem; /* Original spacing for larger screens */
                flex-direction: row; /* Horizontal layout for larger screens */
            }
        }

        .notification-item:hover {
            background-color: #353535; /* Darker hover state */
            transform: translateY(-2px); /* Slight lift on hover */
        }
        .profile-pic {
            width: 48px; /* Slightly smaller profile pic on mobile */
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 1rem; /* Less spacing on mobile */
            border: 2px solid #ff4d4d; /* Accent red border */
            flex-shrink: 0; /* Prevent shrinking */
            /* margin-bottom: 0.75rem; */ /* Space below pic on mobile */ /* Moved to .profile-and-nickname */
        }

        /* Desktop adjustments for profile pic */
        @media (min-width: 640px) {
            .profile-pic {
                width: 56px; /* Original size for larger screens */
                height: 56px;
                margin-right: 1.5rem; /* Original spacing for larger screens */
                /* margin-bottom: 0; */ /* No bottom margin on desktop */ /* Moved to .profile-and-nickname */
            }
        }

        .loading-spinner {
            border: 2px solid #444; /* Darker spinner background */
            border-top: 2px solid #ff4d4d; /* Accent red spinner */
            border-radius: 50%;
            width: 48px; /* Slightly larger spinner */
            height: 48px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ff4d4d; /* Accent red for error messages */
            font-weight: 600; /* Bolder error message */
            margin-top: 1.5rem;
            text-align: center;
        }
        /* Tailwind overrides for text colors to fit dark theme */
        .text-gray-800 { color: #e0e0e0; }
        .text-gray-500 { color: #b0b0b0; }
        .text-blue-600 { color: #7cb3ff; } /* Lighter blue for links */
        .text-gray-200 { color: #e0e0e0; }
        .text-gray-400 { color: #a0a0a0; }
        .text-blue-400 { color: #7cb3ff; margin-left: -8px; } /* Lighter blue for links */

        /* Overlay for loading */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #101010; /* Dark semi-transparent background */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .gif-display {
            margin-top: 0.75rem; /* More spacing */
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            display: block; /* GIF-i yeni sətrə keçirmek üçün */
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
        }
        .notification-content-wrapper {
            display: flex;
            flex-direction: column;
            flex-grow: 1;
            width: 100%; /* Take full width on mobile */
        }

        @media (min-width: 640px) {
            .notification-content-wrapper {
                width: auto; /* Auto width on desktop */
            }
        }

        .notification-main-line {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            width: 100%;
            flex-direction: column; /* Stack vertically on mobile */
        }

        @media (min-width: 640px) {
            .notification-main-line {
                flex-direction: row; /* Horizontal on desktop */
            }
        }

        .notification-text-area {
            flex-grow: 1;
        }
        .comment-content {
            font-size: 0.95rem; /* Slightly larger comment text */
            line-height: 1.4; /* Better readability */
            color: #c0c0c0; /* Lighter gray for comment content */
            padding-left: 0.5rem; /* Indent for comment text */
            border-left: 2px solid #555; /* Subtle border to visually separate comment */
            margin-top: 0.5rem;
        }
        .source-text { /* New style for displaying post/reel text */
            font-size: 0.85rem;
            color: #c0c0c0; /* Lighter text for context */
            margin-top: 0.5rem;
            padding: 0.5rem 1rem;
            background-color: #333;
            border-radius: 6px;
            max-width: 100%; /* Full width on mobile */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            /* margin-left: auto; */ /* Remove auto-margin for mobile stacking */
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-style: italic;
        }

        @media (min-width: 640px) {
            .source-text {
                max-width: 180px; /* Original width for desktop */
                margin-left: auto; /* Align to the right on desktop */
            }
        }

        /* Specific style for liked content to make it more distinct */
        .liked-content-text {
            font-weight: 500;
            color: #ffcc00; /* Yellowish color to signify "liked" */
            margin-left: 0.5rem;
        }

        .profile-and-nickname {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem; /* Space below nickname on mobile */
            width: 100%; /* Take full width on mobile */
        }

        @media (min-width: 640px) {
            .profile-and-nickname {
                margin-bottom: 0; /* No bottom margin on desktop */
                width: auto; /* Auto width on desktop */
            }
        }
    </style>
</head>
<body class="bg-[#101010] flex items-center justify-center p-0">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="loading-spinner"></div>
    </div>

    <div class="container bg-[#101010] p-1 rounded-xl shadow-lg hidden -mt-[15px]"> <!-- Konteyner ilk olaraq gizlədilir -->
        <div id="errorMessage" class="error-message"></div>
        <div id="notificationsList" class="space-y-4 hidden">
            <!-- Bildirişlər bura yüklənəcək -->
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getDatabase, ref, onValue, off, set } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-database.js";

        // Firebase tətbiplərinin konfiqurasiyaları
        const firebaseConfigFollows = {
            apiKey: "AIzaSyDohN9yaNE5lxQet1I9m8s4zD778OyYVzg",
            authDomain: "limon-follow.firebaseapp.com",
            databaseURL: "https://limon-follow-default-rtdb.firebaseio.com",
            projectId: "limon-follow",
            storageBucket: "limon-follow.firebasestorage.app",
            messagingSenderId: "851250357014",
            appId: "1:851250357014:web:d7b99931c1a86dbbc2e637",
            measurementId: "G-N63PV11W8Q"
        };

        const firebaseConfigUser = {
            apiKey: "AIzaSyA6slU31pyfp7tljAB20Vui1gvptSPEv8M",
            authDomain: "limons-user-e43c0.firebaseapp.com",
            databaseURL: "https://limons-user-e43c0-default-rtdb.firebaseio.com",
            projectId: "limons-user-e43c0",
            storageBucket: "limons-user-e43c0.firebasestorage.app",
            messagingSenderId: "484283046830",
            appId: "1:484283046830:web:ad76e2d421b68f22fd063f"
        };

        const firebaseConfigPosts = {
            apiKey: "AIzaSyAjW7zigfYvSyF0DXt3ywu-1PqZDHFbKcc",
            authDomain: "limon-post.firebaseapp.com",
            databaseURL: "https://limon-post-default-rtdb.firebaseio.com",
            projectId: "limon-post",
            storageBucket: "limon-post.firebasestorage.app",
            messagingSenderId: "213746799645",
            appId: "1:213746799645:web:3a4eb82131dc2e1b1622f4"
        };

        const firebaseConfigReels = {
            apiKey: "AIzaSyCI3oZyJXBbZfAFYhhx3mqbtj2lBsVtlVU",
            authDomain: "limon-video.firebaseapp.com",
            databaseURL: "https://limon-video-default-rtdb.firebaseio.com",
            projectId: "limon-video",
            storageBucket: "limon-video.firebasestorage.app",
            messagingSenderId: "1027523081229",
            appId: "1:1027523081229:web:957f99b23a2310a2849144",
            measurementId: "G-GB4KYL0G9V"
        };

        const firebaseConfigPostComments = {
            apiKey: "AIzaSyBin2WZ96znrq97fWwxQK5LrLRpVtmnMPU",
            authDomain: "limon-post-comment.firebaseapp.com",
            databaseURL: "https://limon-post-comment-default-rtdb.firebaseio.com",
            projectId: "limon-post-comment",
            storageBucket: "limon-post-comment.firebasestorage.app",
            messagingSenderId: "276602642114",
            appId: "1:276602642114:web:7c0608c003c5e0a254e55b"
        };

        const firebaseConfigReelComments = {
            apiKey: "AIzaSyC6YBAAly4wH6o1981ntYANsJIzK_eph1I",
            authDomain: "limons-video-comment.firebaseapp.com",
            databaseURL: "https://limons-video-comment-default-rtdb.firebaseio.com",
            projectId: "limons-video-comment",
            storageBucket: "limons-video-comment.firebasestorage.app",
            messagingSenderId: "1097578178676",
            appId: "1:1097578178676:web:a4f8be6d55b883f6ea8921"
        };

        // Yeni bildirişlər verilənlər bazası
        const firebaseConfigNotificationsDB = {
            apiKey: "AIzaSyAHGwh2GGD9mr4K3oyuTsj-kqj8BijbTTU",
  authDomain: "noti-limons.firebaseapp.com",
  databaseURL: "https://noti-limons-default-rtdb.firebaseio.com",
  projectId: "noti-limons",
  storageBucket: "noti-limons.firebasestorage.app",
  messagingSenderId: "863854532081",
  appId: "1:863854532081:web:31310cdf80692a151be050",
  measurementId: "G-72VYSHJ1RC"
        };


        // Firebase tətbiplərini başlat
        const appFollows = initializeApp(firebaseConfigFollows, "followsApp");
        const dbFollows = getDatabase(appFollows);

        const appUser = initializeApp(firebaseConfigUser, "userApp");
        const dbUser = getDatabase(appUser);

        const appPosts = initializeApp(firebaseConfigPosts, "postsApp");
        const dbPosts = getDatabase(appPosts);

        const appReels = initializeApp(firebaseConfigReels, "reelsApp");
        const dbReels = getDatabase(appReels);

        const appPostComments = initializeApp(firebaseConfigPostComments, "postCommentsApp");
        const dbPostComments = getDatabase(appPostComments);

        const appReelComments = initializeApp(firebaseConfigReelComments, "reelCommentsApp");
        const dbReelComments = getDatabase(appReelComments);
        
        const appNotificationsDB = initializeApp(firebaseConfigNotificationsDB, "notificationsDBApp");
        const dbNotificationsDB = getDatabase(appNotificationsDB);

        // UI elementləri
        const notificationsList = document.getElementById("notificationsList");
        const loadingOverlay = document.getElementById("loadingOverlay");
        const errorMessageDiv = document.getElementById("errorMessage");
        const containerDiv = document.querySelector(".container"); // Əsas konteyneri seçin

        // Profil şəkilləri üçün keş (cache)
        const userProfileCache = {};
        let activeListeners = [];
        let allNotifications = new Map(); // Bildirişləri unikal ID ilə saxlamaq üçün Map

        /**
         * Bütün aktiv Firebase dinləyicilərini dayandırır.
         */
        function stopAllListeners() {
            activeListeners.forEach(listener => off(listener.ref, listener.eventType, listener.callback));
            activeListeners = [];
        }

        /**
         * URL-ə &new parametrini əlavə edir və 5 saniyədən sonra onu silir.
         */
        function addAndRemoveNewUrlParam() {
            const url = new URL(window.location.href);
            url.searchParams.set('new', 'true');
            window.history.replaceState({}, '', url.toString());

            setTimeout(() => {
                const newUrl = new URL(window.location.href);
                newUrl.searchParams.delete('new');
                window.history.replaceState({}, '', newUrl.toString());
            }, 5000); // 5 saniyə
        }

        /**
         * Verilmiş mətni qısaldır, ilk iki sözü saxlayır və sonda "..." əlavə edir.
         * @param {string} text - Qısaldılacaq mətn.
         * @returns {string} Qısaldılmış mətn.
         */
        function shortenText(text) {
            if (!text) return '';
            const words = text.split(' ');
            if (words.length > 2) {
                return words.slice(0, 2).join(' ') + '...';
            }
            return text;
        }

        /**
         * Kullanıcının profil bilgilerini (özellikle profil resmini) Firebase'den alır.
         * @param {string} nickname - Kullanıcının @ işareti olmadan ləqəbi.
         * @returns {Promise<string>} - Profil resminin URL'si veya varsayılan resim URL'si.
         */
        async function fetchUserProfile(nickname) {
            const cleanNickname = nickname.startsWith('@') ? nickname.substring(1) : nickname;
            if (userProfileCache[cleanNickname]) {
                return userProfileCache[cleanNickname];
            }

            try {
                const userRef = ref(dbUser, `Users/${cleanNickname}`);
                const snapshot = await new Promise(resolve => onValue(userRef, resolve, { onlyOnce: true }));
                const userDataString = snapshot.val();
                if (userDataString) {
                    const userData = JSON.parse(userDataString);
                    if (userData && userData[2]) {
                        userProfileCache[cleanNickname] = userData[2];
                        return userData[2];
                    }
                }
            } catch (error) {
                console.error(`Profil məlumatlarını gətirərkən xəta: ${cleanNickname}`, error);
            }
            // Varsayılan profil resmi
            return "https://res.cloudinary.com/dhski1gkx/image/upload/v1751823255/icon-7797704_640_iled3f.png"; // Varsayılan profil resmi
        }

        /**
         * Bildirişləri göstərir.
         * @param {Map<string, Object>} notificationsMap - Göstəriləcək bildirişlərin Map-i.
         */
        function renderNotifications(notificationsMap) {
            notificationsList.innerHTML = "";
            const notifications = Array.from(notificationsMap.values());

            if (notifications.length === 0) {
                notificationsList.innerHTML = `<p class="text-center text-gray-500 text-lg py-4">Bildiriş yoxdur.</p>`;
                return;
            }

            // Tarixə görə ən yenidən ən köhnəyə sırala
            notifications.sort((a, b) => b.timestamp - a.timestamp);

            // Yalnız son 50 bildirişi göstər
            const limitedNotifications = notifications.slice(0, 50);

            limitedNotifications.forEach(notification => {
                const notificationDiv = document.createElement("div");
                notificationDiv.className = "notification-item bg-[#181818] hover:bg-[#181818] rounded-lg transition duration-200 ease-in-out";
                let messageText = notification.message;
                let contentHtml = ''; // Şərh mətni, GIF üçün
                let sourceTextElement = ''; // Post və ya video mətni üçün element

                // Şərh məzmununu idarə et
                if (notification.type === 'postComment' || notification.type === 'reelComment' || notification.type === 'reelCommentReply') {
                    // Şərh mətninin əvvəlinə boşluq və "yazdı:" əlavə edirik
                    messageText = `${notification.message}`; 
                    if (notification.isGif && notification.gifUrl) {
                        contentHtml = `<img src="${notification.gifUrl}" alt="GIF" class="gif-display mt-2 ml-0">`; // GIF mətnin altında, sağa sürüşdürülmüş
                    } else if (notification.commentContent) {
                        contentHtml = `<p class="text-gray-300 mt-1 comment-content">"${notification.commentContent}"</p>`; // Şərh mətnini göstər, yeni klass ilə
                    }

                    // Şərhin aid olduğu post/video mətnini göstər
                    if (notification.postText) {
                        sourceTextElement = `<p class="source-text">Post: "${shortenText(notification.postText)}"</p>`;
                    } else if (notification.reelText) {
                        sourceTextElement = `<p class="source-text">Video: "${shortenText(notification.reelText)}"</p>`;
                    }

                } else if (notification.type === 'postLike' && notification.postText) {
                    messageText = `postunuzu bəyəndi. <span class="liked-content-text">"${shortenText(notification.postText)}"</span>`;
                } else if (notification.type === 'reelLike' && notification.reelText) {
                    messageText = `snapınızı bəyəndi. <span class="liked-content-text">"${shortenText(notification.reelText)}"</span>`;
                }


                notificationDiv.innerHTML = `
                    <div class="profile-and-nickname">
                        <img src="${notification.initiatorProfilePic}" alt="${notification.initiatorNickname} profil şəkli" class="profile-pic">
                        <a href="?other=${notification.initiatorNickname.substring(1)}" class="font-semibold text-blue-400 hover:underline text-base">
                            ${notification.initiatorNickname}
                        </a>
                    </div>
                    <div class="notification-content-wrapper">
                        <div class="notification-main-line">
                            <p class="text-gray-200 text-base notification-text-area">
                                ${messageText}
                            </p>
                            <!-- sourceTextElement bəyənmələr üçün messageText-in daxilindədir, şərhlər üçün burada -->
                            ${(notification.type === 'postComment' || notification.type === 'reelComment' || notification.type === 'reelCommentReply') ? sourceTextElement : ''}
                        </div>
                        ${contentHtml} <!-- Şərh mətni və ya GIF burada -->
                    </div>
                `;
                notificationsList.appendChild(notificationDiv);
            });
        }

        /**
         * Bildirişləri `noti-s` verilənlər bazasına əlavə edir.
         * @param {string} targetNickname - Bildirişi alan istifadəçinin ləqəbi (təmiz).
         * @param {Object} notificationData - Bildiriş məlumatları.
         * @param {string} uniqueId - Bildiriş üçün unikal ID.
         */
        async function addNotificationToFirebase(targetNickname, notificationData, uniqueId) {
            const userNotificationsRef = ref(dbNotificationsDB, `notifications/${targetNickname}/${uniqueId}`);
            try {
                // Təkrarçılığı qarşısını almaq üçün bildirişin artıq mövcud olub-olmadığını yoxlayın
                const snapshot = await new Promise(resolve => onValue(userNotificationsRef, resolve, { onlyOnce: true }));
                if (!snapshot.exists()) {
                    await set(userNotificationsRef, notificationData);
                    // URL-ə &new parametrini əlavə et
                    addAndRemoveNewUrlParam();
                }
            } catch (error) {
                console.error("Bildirişi Firebase'ə yazarkən xəta:", error);
            }
        }


        /**
         * Bildirişləri yükləyir və göstərir (real-time).
         * @param {string} targetNickname - Bildirişləri göstəriləcək istifadəçinin ləqəbi (məsələn, "@huseynoff").
         * @param {boolean} displayNothing - Heç nə göstərib-göstərməməyi müəyyənləşdirir.
         */
        async function loadNotifications(targetNickname, displayNothing = false) {
            stopAllListeners(); // Əvvəlki dinləyiciləri dayandır
            allNotifications.clear(); // Köhnə bildirişləri təmizlə

            notificationsList.innerHTML = "";
            errorMessageDiv.textContent = "";
            
            // UI elementlərini ilkin olaraq gizlət
            notificationsList.classList.add("hidden");
            containerDiv.classList.add("hidden"); 
            // Yükləmə üst qatını həmişə göstər
            loadingOverlay.classList.remove("hidden");

            const cleanTargetNickname = targetNickname.startsWith('@') ? targetNickname.substring(1) : targetNickname;
            const formattedTargetNickname = `@${cleanTargetNickname}`;

            if (displayNothing) {
                console.log("Heç nə göstərilmir. Yalnız yükləmə animasiyası müvəqqəti göstərilir.");
                // Qısa müddətdən sonra yükləmə üst qatını gizlət və hər şeyi gizli saxla
                setTimeout(() => {
                    loadingOverlay.classList.add("hidden");
                }, 700); // Yükləməni 0.7 saniyə göstər
                return; // Əlavə emalı və dinləyici əlavə etməyi dayandır
            }
            
            // loadingOverlay gizlədiləcək və containerDiv/notificationsList məlumatlar hazır olduqda
            // notificationsDBListenerCallback içərisində göstəriləcək.
            
            // --- Əsas Dinləyici: dbNotificationsDB-dən oxuyun (göstərmək üçün) ---
            const notificationsDBRef = ref(dbNotificationsDB, `notifications/${cleanTargetNickname}`);
            const notificationsDBListenerCallback = (snapshot) => {
                allNotifications.clear();
                if (snapshot.exists()) {
                    const storedNotifications = snapshot.val();
                    Object.keys(storedNotifications).forEach(key => {
                        const notification = storedNotifications[key];
                        allNotifications.set(key, { ...notification, id: key });
                    });
                }
                renderNotifications(allNotifications);
                loadingOverlay.classList.add("hidden"); // İlkin məlumatlar render edildikdən sonra yükləməni gizlət
                notificationsList.classList.remove("hidden"); // Bildirişler siyahısını göstər
                containerDiv.classList.remove("hidden"); // Bildirişlər hazır olduqda konteyneri göstər
            };
            const notificationsDBListener = onValue(notificationsDBRef, notificationsDBListenerCallback);
            activeListeners.push({ref: notificationsDBRef, eventType: 'value', callback: notificationsDBListenerCallback});


            // --- İkinci Dinləyicilər: Mənbə DB-lərdən hadisələri aşkar edin və dbNotificationsDB-yə yazın ---

            // 1. Təqibçi bildirişləri (pasyak-follows)
            const followsRef = ref(dbFollows, cleanTargetNickname);
            const followsCallback = async (snapshot) => {
                const followersData = snapshot.val();
                if (followersData) {
                    for (const followerNicknameWithAt in followersData) {
                        const status = followersData[followerNicknameWithAt];
                        if (status === "+" || status === '"+"') {
                            const followerNickname = followerNicknameWithAt;
                            const profilePic = await fetchUserProfile(followerNickname.substring(1));
                            const uniqueId = `follow_${followerNickname.substring(1)}_${cleanTargetNickname}`;
                            const notificationData = {
                                type: 'follow',
                                timestamp: Date.now(),
                                initiatorNickname: followerNickname,
                                targetNickname: formattedTargetNickname,
                                message: "sizi izləməyə başladı.",
                                initiatorProfilePic: profilePic,
                                isGif: false,
                                gifUrl: null
                            };
                            await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                        }
                    }
                }
            };
            const followsListener = onValue(followsRef, followsCallback);
            activeListeners.push({ref: followsRef, eventType: 'value', callback: followsCallback});


            // 2. Post bəyənmə bildirişləri (pasyakaaz)
            const postsRef = ref(dbPosts, 'posts');
            const postsCallback = async (postsSnapshot) => {
                const postsData = postsSnapshot.val();
                if (postsData) {
                    for (const postId in postsData) {
                        const postDataString = postsData[postId];
                        const post = JSON.parse(postDataString);
                        if (post.nickname === formattedTargetNickname) {
                            const likesRef = ref(dbPosts, `likes/${postId}`);
                            const likesCallback = async (likesSnapshot) => {
                                const likesData = likesSnapshot.val();
                                if (likesData) {
                                    for (const likerNickname in likesData) {
                                        if (likesData[likerNickname] === true && likerNickname !== 'count' && likerNickname !== 'users') {
                                            const profilePic = await fetchUserProfile(likerNickname.substring(1));
                                            const uniqueId = `postLike_${postId}_${likerNickname.substring(1)}_${cleanTargetNickname}`;
                                            const notificationData = {
                                                type: 'postLike',
                                                timestamp: Date.now(),
                                                initiatorNickname: likerNickname,
                                                targetNickname: formattedTargetNickname,
                                                message: `postunuzu bəyəndi.`,
                                                initiatorProfilePic: profilePic,
                                                postText: post.text || '', // Postun mətni əlavə edildi
                                                isGif: false,
                                                gifUrl: null
                                            };
                                            await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                                        }
                                    }
                                }
                            };
                            const likesListener = onValue(likesRef, likesCallback);
                            activeListeners.push({ref: likesRef, eventType: 'value', callback: likesCallback});
                        }
                    }
                }
            };
            const postsListener = onValue(postsRef, postsCallback);
            activeListeners.push({ref: postsRef, eventType: 'value', callback: postsCallback});


            // 3. Video bəyənmə bildirişləri (pasyak-reels)
            const reelsRef = ref(dbReels, 'reels');
            const reelsCallback = async (reelsSnapshot) => {
                const reelsData = reelsSnapshot.val();
                if (reelsData) {
                    for (const reelId in reelsData) {
                        const reelDataString = reelsData[reelId];
                        const reel = JSON.parse(reelDataString);
                        if (reel.nickname === formattedTargetNickname) {
                            const likesRef = ref(dbReels, `likes/${reelId}/users`);
                            const likesCallback = async (likesSnapshot) => {
                                const likesData = likesSnapshot.val();
                                if (likesData) {
                                    for (const likerNickname in likesData) {
                                        if (likesData[likerNickname] === true) {
                                            const profilePic = await fetchUserProfile(likerNickname.substring(1));
                                            const uniqueId = `reelLike_${reelId}_${likerNickname.substring(1)}_${cleanTargetNickname}`;
                                            const notificationData = {
                                                type: 'reelLike',
                                                timestamp: Date.now(),
                                                initiatorNickname: likerNickname,
                                                targetNickname: formattedTargetNickname,
                                                message: `snapınızı bəyəndi.`,
                                                initiatorProfilePic: profilePic,
                                                reelText: reel.text || '', // Videonun mətni əlavə edildi
                                                isGif: false,
                                                gifUrl: null
                                            };
                                            await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                                        }
                                    }
                                }
                            };
                            const likesListener = onValue(likesRef, likesCallback);
                            activeListeners.push({ref: likesRef, eventType: 'value', callback: likesCallback});
                        }
                    }
                }
            };
            const reelsListener = onValue(reelsRef, reelsCallback);
            activeListeners.push({ref: reelsRef, eventType: 'value', callback: reelsCallback});


            // 4. Post şərh bildirişləri (gonline-1880b)
            const allPostsRef = ref(dbPosts, 'posts');
            const allPostsCallback = async (allPostsSnapshot) => {
                const allPostsData = allPostsSnapshot.val();
                if (allPostsData) {
                    for (const postId in allPostsData) {
                        const postDataString = allPostsData[postId];
                        const post = JSON.parse(postDataString);
                        if (post.nickname === formattedTargetNickname) {
                            const postCommentsRef = ref(dbPostComments, `comments/${postId}`);
                            const commentsCallback = async (commentsSnapshot) => {
                                const commentsData = commentsSnapshot.val();
                                if (commentsData) {
                                    for (const commentId in commentsData) {
                                        const comment = commentsData[commentId];
                                        if (comment.nickname && comment.nickname !== formattedTargetNickname) {
                                            const profilePic = await fetchUserProfile(comment.nickname.substring(1));
                                            const uniqueId = `postComment_${postId}_${comment.nickname.substring(1)}_${cleanTargetNickname}_${comment.timestamp}`;
                                            const notificationData = {
                                                type: 'postComment',
                                                timestamp: comment.timestamp || Date.now(),
                                                initiatorNickname: comment.nickname,
                                                targetNickname: formattedTargetNickname,
                                                message: `postunuza şərh yazdı:`,
                                                initiatorProfilePic: profilePic,
                                                postText: post.text || '', // Postun mətni əlavə edildi
                                                commentContent: comment.isGif ? null : comment.text, // Şərh mətni
                                                isGif: comment.isGif || false,
                                                gifUrl: comment.isGif ? comment.text : null,
                                            };
                                            await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                                        }
                                    }
                                }
                            };
                            const commentsListener = onValue(postCommentsRef, commentsCallback);
                            activeListeners.push({ref: postCommentsRef, eventType: 'value', callback: commentsCallback});
                        }
                    }
                }
            };
            const allPostsListener = onValue(allPostsRef, allPostsCallback);
            activeListeners.push({ref: allPostsRef, eventType: 'value', callback: allPostsCallback});


            // 5. Video şərh bildirişləri (reply-eb654)
            const allReelsRef = ref(dbReels, 'reels');
            const allReelsCallback = async (allReelsSnapshot) => {
                const allReelsData = allReelsSnapshot.val();
                if (allReelsData) {
                    for (const reelId in allReelsData) {
                        const reelDataString = reelsData[reelId];
                        const reel = JSON.parse(reelDataString);
                        if (reel.nickname === formattedTargetNickname) {
                            const reelCommentsRef = ref(dbReelComments, `comments/${reelId}`);
                            const commentsCallback = async (commentsSnapshot) => {
                                const commentsData = commentsSnapshot.val();
                                if (commentsData) {
                                    for (const commentId in commentsData) {
                                        const comment = commentsData[commentId];
                                        // Əsas səviyyə şərhləri idarə edin
                                        if (comment.user && `@${comment.user}` !== formattedTargetNickname) {
                                            const profilePic = await fetchUserProfile(comment.user);
                                            const uniqueId = `reelComment_${reelId}_${comment.user}_${cleanTargetNickname}_${comment.timestamp}`;
                                            const notificationData = {
                                                type: 'reelComment',
                                                timestamp: comment.timestamp || Date.now(),
                                                initiatorNickname: `@${comment.user}`,
                                                targetNickname: formattedTargetNickname,
                                                message: `snapınıza şərh yazdı:`,
                                                initiatorProfilePic: profilePic,
                                                reelText: reel.text || '', // Videonun mətni əlavə edildi
                                                commentContent: comment.isGif ? null : comment.text, // Şərh mətni
                                                isGif: comment.isGif || false,
                                                gifUrl: comment.isGif ? comment.text : null,
                                            };
                                            await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                                        }
                                        // Cavabları idarə edin
                                        if (comment.replies) {
                                            for (const replyId in comment.replies) {
                                                const reply = comment.replies[replyId];
                                                if (reply.user && `@${reply.user}` !== formattedTargetNickname) {
                                                    const profilePic = await fetchUserProfile(reply.user);
                                                    const uniqueId = `reelCommentReply_${reelId}_${commentId}_${reply.user}_${cleanTargetNickname}_${reply.timestamp}`;
                                                    const notificationData = {
                                                        type: 'reelCommentReply',
                                                        timestamp: reply.timestamp || Date.Now(),
                                                        initiatorNickname: `@${reply.user}`,
                                                        targetNickname: formattedTargetNickname,
                                                        message: `snapınızda şərhə cavab yazdı:`,
                                                        initiatorProfilePic: profilePic,
                                                        reelText: reel.text || '', // Videonun mətni əlavə edildi
                                                        commentContent: reply.isGif ? null : reply.text, // Şərh mətni
                                                        isGif: reply.isGif || false,
                                                        gifUrl: reply.isGif ? reply.text : null,
                                                    };
                                                    await addNotificationToFirebase(cleanTargetNickname, notificationData, uniqueId);
                                                }
                                            }
                                        }
                                    }
                                }
                            };
                            const commentsListener = onValue(reelCommentsRef, commentsCallback);
                            activeListeners.push({ref: reelCommentsRef, eventType: 'value', callback: commentsCallback});
                        }
                    }
                }
            };
            const allReelsListener = onValue(allReelsRef, allReelsCallback);
            activeListeners.push({ref: allReelsRef, eventType: 'value', callback: allReelsCallback});
            
        }

        // Səhifə yüklənəndə
        document.addEventListener("DOMContentLoaded", () => {
            const urlParams = new URLSearchParams(window.location.search);
            // encodeURIComponent istifadə edilməsinə ehtiyac yoxdur, çünki URL-də @ simvolunu saxlamaq istəyirik
            const userNickname = urlParams.get('user') || urlParams.get('other'); // Həm 'user', həm də 'other' parametrləri işləyəcək
            const displayNothing = urlParams.has('other'); 

            if (userNickname) {
                loadNotifications(userNickname, displayNothing);
            } else {
                errorMessageDiv.textContent = "Zəhmət olmasa, URL-də '?user=@ləqəbi' və ya '?other=@ləqəbi' formatında bir istifadəçi ləqəbi təyin edin (məsələn, ?user=huseynoff).";
                loadingOverlay.classList.add("hidden"); // Ləqəb yoxdursa yükləmə üst qatını gizlət
                containerDiv.classList.add("hidden"); // Konteyneri gizlət
            }
        });

        // Səhifədən çıxarkən dinləyiciləri təmizləyin
        window.addEventListener('beforeunload', stopAllListeners);
    </script>
</body>
</html>
