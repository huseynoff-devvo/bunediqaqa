<!DOCTYPE html>
<html lang="az">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Paylaşımlar</title>
  <style>
    @import url('https://fonts.googleapis.com/icon?family=Material+Icons');
    body {
      background: #181818;
      color: white;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 5px;
    }
    .post {
      background: #1e1e1e;
      border-radius: 10px;
      margin-top: 15px;
      padding: 15px;
    }
    .post-header {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    .profile-pic {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }
    .username-box {
      display: flex;
      flex-direction: column;
    }
    .userid {
      font-weight: bold;
      font-size: 1rem;
    }
    .nickname {
      font-size: 0.8rem;
      color: #aaa;
    }
    .post-text {
      margin: 10px 0;
    }
    .post-image {
      width: 100%;
      max-width: 100%;
      border-radius: 8px;
    }
    .post-time {
      font-size: 0.8rem;
      color: #aaa;
      text-align: right;
      margin-top: 5px;
    }
    .like-button {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      display: flex;
      align-items: center;
      padding: 5px;
      margin-top: 5px;
      user-select: none;
    }
    .like-button.liked {
      color: #ff4d4d;
    }
    .like-button .material-icons {
      margin-right: 5px;
    }
  </style>
</head>
<body>
  <div id="posts"></div>

  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyC_wr_ji3crAVEmRwbHmJ0YJfx46B_as2w",
      authDomain: "pasyakaaz.firebaseapp.com",
      projectId: "pasyakaaz",
      storageBucket: "pasyakaaz.appspot.com",
      messagingSenderId: "289629756800",
      appId: "1:289629756800:web:f7a6f00fcce2b1eb28b565"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const postsContainer = document.getElementById("posts");

    const urlParams = new URLSearchParams(window.location.search);
    const currentUser = urlParams.get("user") || "anonim";
    const onlyMyPosts = urlParams.get("myPosts") === "true";
    const likedPostsOnly = urlParams.get("liked") === "true";

    function renderPost(postId, data, isLikedByUser) {
      const postEl = document.createElement("div");
      postEl.className = "post";

      const header = document.createElement("div");
      header.className = "post-header";

      const img = document.createElement("img");
      img.className = "profile-pic";
      img.src = data.profile || "https://via.placeholder.com/36?text=?";

      const userBox = document.createElement("div");
      userBox.className = "username-box";

      const userId = document.createElement("div");
      userId.className = "userid";
      userId.textContent = data.user || "Anonim";

      const nickname = document.createElement("div");
      nickname.className = "nickname";
      nickname.textContent = data.nickname || "";

      userBox.appendChild(userId);
      userBox.appendChild(nickname);
      header.appendChild(img);
      header.appendChild(userBox);
      postEl.appendChild(header);

      if (data.text) {
        const text = document.createElement("div");
        text.className = "post-text";
        text.textContent = data.text;
        postEl.appendChild(text);
      }

      if (data.image) {
        const image = document.createElement("img");
        image.className = "post-image";
        image.src = data.image.replace(/\\/g, '').trim();
        postEl.appendChild(image);
      }

      const likeBtn = document.createElement("button");
      likeBtn.className = "like-button";
      likeBtn.innerHTML = `<span class="material-icons">favorite</span><span class="like-count">${data.likes || 0}</span>`;

      if (isLikedByUser) {
        likeBtn.classList.add("liked");
      }

      likeBtn.addEventListener("click", () => {
        const likeRef = db.ref(`likes/${postId}/${currentUser}`);
        likeRef.once("value").then(snap => {
          if (snap.exists()) {
            likeRef.remove();
            db.ref(`posts/${postId}`).once("value").then(postSnap => {
              const parsed = typeof postSnap.val() === 'string' ? JSON.parse(postSnap.val()) : postSnap.val();
              parsed.likes = Math.max((parsed.likes || 1) - 1, 0);
              db.ref(`posts/${postId}`).set(JSON.stringify(parsed));
              likeBtn.classList.remove("liked");
              likeBtn.querySelector(".like-count").textContent = parsed.likes;
            });
          } else {
            likeRef.set(true);
            db.ref(`posts/${postId}`).once("value").then(postSnap => {
              const parsed = typeof postSnap.val() === 'string' ? JSON.parse(postSnap.val()) : postSnap.val();
              parsed.likes = (parsed.likes || 0) + 1;
              db.ref(`posts/${postId}`).set(JSON.stringify(parsed));
              likeBtn.classList.add("liked");
              likeBtn.querySelector(".like-count").textContent = parsed.likes;
            });
          }
        });
      });

      postEl.appendChild(likeBtn);

      const time = document.createElement("div");
      time.className = "post-time";
      time.textContent = data.time || "";
      postEl.appendChild(time);

      return postEl;
    }

    function loadPosts() {
      db.ref("likes").once("value").then(likesSnap => {
        const likesData = likesSnap.val() || {};
        db.ref("posts").on("value", postsSnap => {
          postsContainer.innerHTML = "";
          postsSnap.forEach(child => {
            try {
              const postId = child.key;
              const postRaw = child.val();
              const data = typeof postRaw === 'string' ? JSON.parse(postRaw) : postRaw;
              const isLiked = likesData[postId] && likesData[postId][currentUser];
              if (onlyMyPosts && data.user !== currentUser) return;
              if (likedPostsOnly && !isLiked) return;
              const postEl = renderPost(postId, data, isLiked);
              postsContainer.appendChild(postEl);
            } catch (e) {
              console.warn("Xəta post formatinda:", child.key);
            }
          });
        });
      });
    }

    loadPosts();
  </script>
</body>
</html>
