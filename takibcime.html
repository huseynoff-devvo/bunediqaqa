<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>İzlədiklərin</title>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <style>
        * {
            -webkit-tap-highlight-color: transparent;
        }
        *:focus,
        *:active,
        *:focus-visible {
            outline: none !important;
            box-shadow: none !important;
        }
        body {
            background-color: #121212;
            color: white;
            font-family: 'Segoe UI', Arial, sans-serif;
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 0;
        }

        #userList {
            width: 90%;
            max-width: 600px;
        }

        .user {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            background: #242424;
            padding: 10px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease;
            width: 100%;
        }

        .user:hover {
            background: #303030;
        }

        .user img.profile-pic {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin-right: 15px;
            object-fit: cover;
        }
        
        .user-info {
            display: flex;
            flex-direction: column;
        }

        .username {
            font-weight: bold;
            display: flex;
            align-items: center;
            font-size: 16px;
        }

        .status-badge {
            width: 16px;
            height: 16px;
            margin-left: 5px;
        }

        #loadingSpinner {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 40px;
        }

        .spinner {
            border: 3px solid #333;
            border-top: 3px solid white;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="loadingSpinner"><div class="spinner"></div></div>
    <div id="userList" style="display: none;"></div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const currentUser = urlParams.get('user');

        const followConfig = {
            apiKey: "AIzaSyBA0gfZVLCnGV2Hli6BjEbq08SmLzFkshg",
            authDomain: "pasyak-following.firebaseapp.com",
            databaseURL: "https://pasyak-following-default-rtdb.firebaseio.com",
            projectId: "pasyak-following",
            storageBucket: "pasyak-following.firebasestorage.app",
            messagingSenderId: "538884111637",
            appId: "1:538884111637:web:c2c3532a1bda359aacbd1c"
        };

        const userConfig = {
            apiKey: "AIzaSyBHRY6yGGT9qHV8df1OJXtmbQ7QxWu69ps",
            authDomain: "pasyak-user.firebaseapp.com",
            databaseURL: "https://pasyak-user-default-rtdb.firebaseio.com",
            projectId: "pasyak-user",
            storageBucket: "pasyak-user.firebasestorage.app",
            messagingSenderId: "898141218588",
            appId: "1:898141218588:web:f3477f39d96bceb2727cd9"
        };
        
        const tickConfig = {
            apiKey: "AIzaSyA2RNLGS-qUkhq6zNGtoUMTXJ3jNTfuHoE",
            databaseURL: "https://pasyak-tick-default-rtdb.firebaseio.com"
        };

        const premiumConfig = {
          apiKey: "AIzaSyByZEbmw0w1Q5U1LfOrFsjCpd9CXzwyHyc",
          databaseURL: "https://pasyak-premium-default-rtdb.firebaseio.com"
        };

        const followApp = firebase.initializeApp(followConfig, "followApp");
        const userApp = firebase.initializeApp(userConfig, "userApp");
        const tickApp = firebase.initializeApp(tickConfig, "tickApp");
        const premiumApp = firebase.initializeApp(premiumConfig, "premiumApp");

        const followDb = followApp.database();
        const userDb = userApp.database();
        const tickDb = tickApp.database();
        const premiumDb = premiumApp.database();

        let tickUsers = {};
        let premiumUsers = {};

        function getStatusBadgeUrl(nickname) {
            const isTick = tickUsers[nickname] === "+";
            const isPremium = premiumUsers[nickname] === "+";

            if (isTick && isPremium) {
                return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/premium-tick_ne5yjz.png";
            } else if (isTick) {
                return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/tik_tiozjv.png";
            } else if (isPremium) {
                return "https://res.cloudinary.com/dhski1gkx/image/upload/v1754247890/premium_aomgkl.png";
            }
            return null;
        }

        function renderUser(name, nick, img) {
            const userDiv = document.createElement('div');
            userDiv.className = 'user';
            userDiv.onclick = () => {
                window.location.href = `?other=${nick}`;
            };

            const statusBadgeUrl = getStatusBadgeUrl(nick);
            const statusBadgeHtml = statusBadgeUrl ? `<img class="status-badge" src="${statusBadgeUrl}" alt="Status" />` : '';

            userDiv.innerHTML = `
                <img class="profile-pic" src="${img.trim()}" alt="${nick}">
                <div class="user-info">
                    <div class="username">${name}${statusBadgeHtml}</div>
                    <div>@${nick}</div>
                </div>
            `;
            document.getElementById('userList').appendChild(userDiv);
        }

        function showLoading(state) {
            document.getElementById('loadingSpinner').style.display = state ? 'flex' : 'none';
        }

        function showUserList(state) {
            document.getElementById('userList').style.display = state ? 'block' : 'none';
        }

        function clearUserList() {
            document.getElementById('userList').innerHTML = '';
        }

        async function loadFollowings() {
            if (!currentUser) {
                showLoading(false);
                showUserList(true);
                return;
            }

            showLoading(true);

            // Bütün lazımi məlumatları paralel yükləmək üçün Promise.all istifadə edirəm
            const [followSnap, tickSnap, premiumSnap] = await Promise.all([
                followDb.ref(currentUser).once('value'),
                tickDb.ref("tick").once('value'),
                premiumDb.ref("premium").once('value')
            ]);
            
            tickUsers = tickSnap.val() || {};
            premiumUsers = premiumSnap.val() || {};
            const followData = followSnap.val();

            if (!followData) {
                showLoading(false);
                showUserList(true);
                return;
            }

            const usernames = Object.keys(followData).filter(username => {
                const value = (followData[username] + '').replaceAll('"', '');
                return value === '+';
            });
            
            if (usernames.length === 0) {
                showLoading(false);
                showUserList(true);
                return;
            }

            const userPromises = usernames.map(username => {
                const cleanUsername = username.replace('@', ''); // `@` nişanəsini təmizləyir
                return userDb.ref("Users/" + cleanUsername).once('value');
            });

            const userSnaps = await Promise.all(userPromises);
            
            clearUserList();
            userSnaps.forEach(userSnap => {
                try {
                    const val = userSnap.val();
                    if (val) {
                        const [name, nick, img] = JSON.parse(val);
                        renderUser(name, nick, img);
                    }
                } catch (e) {
                    console.error("Profil oxunmadı:", userSnap.ref.key, e);
                }
            });

            showLoading(false);
            showUserList(true);
        }

        loadFollowings();
    </script>
</body>
</html>
